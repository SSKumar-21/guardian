<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Guardian Angel</title>

  <!-- Styles -->
  <link rel="stylesheet" href="/styles/landing.css" />
  <link rel="stylesheet" href="/styles/menu.css">
  <link rel="stylesheet" href="/styles/darkMode.css">
  <link rel="stylesheet" href="/styles/account.css">
  <link rel="stylesheet" href="/styles/logout.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="icon" href="https://i.ibb.co/WvB9Ncj3/logo.jpg">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>

<body>
  <div class="main">

    <!-- Include Header (unchanged structure inside partial) -->
    <%- include('partials/header.ejs') %>


    <div class="lower">

      <!-- Home Page -->
      <div class="lower page" id="page-home">
        <div class="mid">
          <h1>Emergency Help Needed?</h1>
          <p>Press the button below and help will reach shortly</p>
          <img src="media/center_call.png" alt="Emergency" />
        </div>
      </div>
      <!-- Location Page -->
      <div class="lower page" id="page-location" style="display: none">
        <div class="mid">
          <p id="status">Fetching current location...</p>
          <div id="map" style="height: 400px;"></div>
        </div>
      </div>

      <!-- Bot Page -->
      <div class="lower page" id="page-bot" style="display: none">
        <div class="webchat">
          <iframe
            style="height: 100%; width: 100%; border: none;"
            src="https://cdn.botpress.cloud/webchat/v2.4/shareable.html?configUrl=https://files.bpcontent.cloud/2025/06/01/02/20250601023409-6MJU22GE.json"
          ></iframe>
        </div>
      </div>

      <!-- Menu Page -->
      <div class="lower page" id="page-menu" style="display: none">
        <div class="menu-header">Profile</div>

        <div class="menu-item" id="accountBtn">
          <i class="fas fa-user"></i><span>Account</span><i class="fas fa-chevron-right arrow"></i>
        </div>

        <div class="menu-section-title">General Settings</div>

        <div class="menu-item">
          <i class="fas fa-globe"></i><span>Language</span><i class="fas fa-chevron-right arrow"></i>
        </div>
        <div class="menu-item" id="showAboutBtn">
          <i class="fas fa-question"></i><span>About</span><i class="fas fa-chevron-right arrow"></i>
        </div>
        <div class="menu-item" id="showTermBtn">
          <i class="fas fa-exclamation-triangle"></i><span>Terms & Conditions</span><i class="fas fa-chevron-right arrow"></i>
        </div>
        <a href="/GuardianAngel.apk" download>
          <div class="menu-item">
            <i class="fas fa-share-alt"></i>
            <span>Download Guardian Angel</span>
            <i class="fas fa-chevron-right arrow"></i>
          </div>
        </a>
        <div class="menu-item">
          <i class="fas fa-moon"></i>
          <span>Dark Mode</span>
          <div class="toggle-container">
            <div id="darkToggle" class="toggle"></div>
          </div>
        </div>
      </div>

      
      <!-- ACCOUNT Page -->
<div class="lower page" id="page-settings" style="display: none">
  <div class="menu-header">Account</div>

  <div class="menu-section-title">Profile Settings</div>
  <div class="menu-item" id="personalInfoBtn">
      <i class="fas fa-id-card"></i>
      <span>Personal Information</span>
      <i class="fas fa-chevron-right arrow"></i>
  </div>

  <div class="menu-section-title">Contacts</div>
  <div class="menu-item" id="trustedContactBtn">
      <i class="fas fa-user-shield"></i>
      <span>Trusted Contact</span>
      <i class="fas fa-chevron-right arrow"></i>
  </div>

  <div class="menu-section-title">Account Actions</div>
  <div class="menu-item" id="logoutBtn">
      <i class="fas fa-sign-out-alt"></i>
      <span>Logout</span>
      <i class="fas fa-chevron-right arrow"></i>
  </div>
  <a href="/Delete/<%=userId%>">
  <div class="menu-item danger" id="deleteBtn" >
      <i class="fas fa-trash-alt"></i>
      <span>Delete</span>
      <i class="fas fa-chevron-right arrow"></i>
  </div>
</a>
</div>

<!-- TRUSTED CONTACT Page -->

  <div class="lower page" id="page-trustedcontact" style="display:none">
    <div class="menu-header">Trusted Contact</div>

    <form id="trustedContactForm" method="post" action="/trusted-contacts/<%=userId%>">
      <input type="text" name="name" placeholder="Name" required>
      <select name="relation" required>
        <option value="" disabled selected>Select Relation</option>
        <option value="Parent">Parent</option>
        <option value="Sibling">Sibling</option>
        <option value="Friend">Friend</option>
        <option value="Spouse">Spouse</option>
        <option value="Colleague">Colleague</option>
        <option value="Other">Other</option>
      </select>    
      <input type="tel" name="phone" placeholder="Phone Number" pattern="[0-9]{10}" required>
      <button type="submit" id="addContactBtn">Add Contact</button>
    </form>

    <div class="menu-section-title">Saved Contacts</div>
    <ul id="contactList">
      <% if (contacts.length === 0) { %>
        <li>No contacts found</li>
      <% } else { %>
        <% contacts.forEach(contact => { %>
          <li>
            <strong><%= contact.Name %></strong><br>
            Relation: <%= contact.Relation %><br>
            Phone: <%= contact.Pho %>
          </li>

        <% }) %>
      <% } %>
    </ul>
    
    
  </div>

  <!-- PERSONAL INFORMATION Page -->
<div class="lower page" id="page-personalinfo" style="display:none">
  <div class="menu-header">Personal Information</div>

  <form id="personalInfoForm" method="post" action="/update-personal-info/<%= userId %>">

    <div class="form-group">
      <label for="username">Username</label>
      <input type="text" id="username" name="username" value="<%= user.username %>" required>
    </div>


    <div class="form-group">
      <label for="email">Email (cannot be changed)</label>
      <input type="email" id="email" name="email" value="<%= user.email %>" readonly>
    </div>


    <div class="form-group">
      <label for="phone">Phone</label>
      <input type="tel" id="phone" name="phone" value="<%= user.phone %>" pattern="[0-9]{10}" required>
    </div>


    <div class="form-group">
      <label for="address">Address</label>
      <textarea id="address" name="address" rows="2"><%= user.address %></textarea>
    </div>

    <button type="submit" id="savePersonalInfoBtn">Save Changes</button>
  </form>
</div>


  </div>
  </div>

  <!-- Include Footer (unchanged structure inside partial) -->
  <%- include('partials/footer.ejs') %>

  <!-- Scripts -->
  <script src="https://cdn.botpress.cloud/webchat/v2.4/inject.js"></script>
  <script src="/script/bot.js"></script>
  
  <script src="/script/minimiseLoading.js"></script>
  <script src="/script/deviceCheck.js"></script>

  <script src="/script/map.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="/script/popup.js"></script>
  <script src="/script/logout.js"></script>

<script type="module">
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyB5xMzpAbzgvL6uNAv5uZluPqLR5iuLdSY",
      authDomain: "her-6d883.firebaseapp.com",
      databaseURL: "https://her-6d883-default-rtdb.firebaseio.com",
      projectId: "her-6d883",
      storageBucket: "her-6d883.appspot.com",
      messagingSenderId: "660185862853",
      appId: "1:660185862853:web:9852b01191f0931dd016ac"
    };

    // Import Firebase SDK modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get userId from EJS template
    const userId = "<%= userId %>";

    // Auto-run on page load
    window.addEventListener("load", () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;

          // Save location in Firebase
          update(ref(db, "users/" + userId + "/location"), {
            latitude: lat,
            longitude: lon,
            timestamp: new Date().toISOString()
          }).then(() => {
            console.log("✅ Location saved for user:", userId);
          }).catch((err) => {
            console.error("❌ Error saving location:", err);
          });

        }, (err) => {
          console.error("❌ Geolocation error:", err);
        });
      } else {
        console.error("Geolocation not supported in this browser.");
      }
    });
  </script>
    

</body>
</html>
